<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
<svg version="1.1"
     baseProfile="full"
     width="700"
     height="400"
     xmlns="http://www.w3.org/2000/svg"
     id="stage"
     style='background-color: #CCC;'>

  <image xlink:href="img/plane.png" id="plane"/>

  <line id="weight" x1="100" y1="200" x2="250" y2="50" stroke="red" stroke-width="2" />
  <line id="thrust" x1="120" y1="200" x2="250" y2="50" stroke="green" stroke-width="2" />
  <line id="lift-drag" x1="130" y1="200" x2="250" y2="50" stroke="blue" stroke-width="2" />

</svg>

<script>



function placeElement(element, x, y, angle){
  var angle_degrees = angle  * 180/Math.PI;
  element.setAttribute('x', x-width/2);
  element.setAttribute('y', y-height/2);
  element.setAttribute('transform', 'rotate('+angle_degrees+' '+x+' '+y+')')
}

function placeVector(element, x1, y1, vector){

  var x2 = x1 - vector_scale * vector.magnitude * Math.cos(vector.angle);
  var y2 = y1 - vector_scale * vector.magnitude * Math.sin(vector.angle);

  element.setAttribute('x1', x1);
  element.setAttribute('y1', y1);
  element.setAttribute('x2', x2);
  element.setAttribute('y2', y2);
}

var keys = [
  {code: 37, name: 'pitch_up'},
  {code: 39, name: 'pitch_down'},
  {code: 38, name: 'throttle'},
  {code: 40, name: 'brake'}
];

var frame = 0;
var x = 500;
var y = 150;
var velocity = {magnitude: 0, angle: 0 * Math.PI/180}; // directon of tranvel compared to groun
var orientation = 0 * Math.PI/180; // direction plane is facing (may differ from angle of travel)
var thrust_magnitude = 0.1;
var mass = 1;
var dangle = 2 * Math.PI/180;
var plane = document.getElementById('plane');
var weight = document.getElementById('weight');
var lift_drag = document.getElementById('lift-drag');
var width = plane.getBoundingClientRect().width;
var height = plane.getBoundingClientRect().height;
var stage = document.getElementById('stage');
var stage_width = stage.getAttribute('width')/1;
var stage_height = stage.getAttribute('height')/1;
var lift_drag_constant = 0.01;
var gravity = 0.02;
var interval = 20;
var vector_scale = 1500;
var go = true;

var input = {
  'elevator_up': null,
  'elevator_down': null,
  'throttle': null
};


setInterval(function(){
  if(go){
    update();
    render();
  }
}, interval);

function clearInput(){
  input.elevator_up = null;
  input.elevator_down = null;
}

function update(){
  frame++;
  updateOrientation();
  updateVelocity();
  updatePosition();
}

function updateOrientation(){
  if(input.pitch_up){
    orientation-=dangle;
  }
  if(input.pitch_down){
    orientation+=dangle;
  }
}

function updateVelocity(){

  var forces_total = sumVectors([
    getThrustForce(),
    getGravityForce(),
    getLiftDragForce()
  ]);

  var acceleration = {
    angle: forces_total.angle,
    magnitude: forces_total.magnitude / mass
  };

  velocity = sumVectors([velocity, acceleration]);
}

function getGravityForce(){
  return {angle: -Math.PI/2, magnitude: gravity*mass};
}

function getLiftDragForce(){

  var air_velocity = getAirVelocity();
  var relative_air_velocity = subtractVectors(velocity, air_velocity);

  var angle_of_attack = relative_air_velocity.angle - orientation;

  var angle = orientation + Math.PI/2;
  var magnitude = lift_drag_constant * relative_air_velocity.magnitude * Math.cos(angle_of_attack);

  if((angle_of_attack % 2*Math.PI) > Math.PI/2){magnitude *= -1;}
  
  return {
    angle: angle,
    magnitude: magnitude
  };
}

function getAirVelocity(){
  return {angle: 0, magnitude: 0};
}

function subtractVectors(v1, v2){

  var v2_reversed = {
    angle: v2.angle,
    magnitude: (-1 * v2.magnitude)
  };

  return sumVectors([v1, v2_reversed]); 
}

function sumVectors(vectors){

  var total_x = 0;
  var total_y = 0;
  var total_vector = {};

  vectors.forEach(function(vector){
    total_x += vector.magnitude * Math.cos(vector.angle);
    total_y += vector.magnitude * Math.sin(vector.angle);
  });

  total_vector.magnitude = Math.sqrt(total_x*total_x + total_y*total_y);
  total_vector.angle = Math.atan2(total_y, total_x);

  return total_vector;
}

function getThrustForce(){
  return {angle: orientation, magnitude: input.throttle ? thrust_magnitude : 0};
}

function updatePosition(){
  var dx = -velocity.magnitude * Math.cos(velocity.angle);
  var dy = -velocity.magnitude * Math.sin(velocity.angle);
  x += dx;
  y += dy;

  // bound to box
  if(y > stage_height){y = stage_height;}
  if(y < 0){y = 0;}

  if(x<0){x = stage_width+x;}
  if(x>stage_width){x = x-stage_width;}
}

function render(){
  placeElement(plane, x, y, orientation );
  placeVector(weight, x, y, getGravityForce());
  placeVector(thrust, x, y, getThrustForce());
  placeVector(lift_drag, x, y, getLiftDragForce());
}

document.addEventListener('keydown', function(event) {
  keys.forEach(function(key){
    if(event.keyCode == key.code) {
        input[key.name] = true;
    }
  });
});

document.addEventListener('keyup', function(event) {
  keys.forEach(function(key){
    if(event.keyCode == key.code) {
        input[key.name] = false;
    }
  });
});


</script>
</body>
</html>